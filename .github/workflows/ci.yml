name: Java Selective Test Runner

on:
  workflow_dispatch:
    inputs:
      run_mode:
        description: '–†–µ–∂–∏–º –∑–∞–ø—É—Å–∫–∞ (changed, all, custom, tag)'
        required: true
        default: 'changed'
        type: choice
        options:
          - changed
          - all
          - custom
          - tag
      test_class:
        description: '–ò–º—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: q1, stop)'
        required: false
      tag:
        description: 'JUnit —Ç–µ–≥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: login, critical)'
        required: false

  push:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Show test files
        run: |
          echo "üìÇ –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –≤ src/test/java:"
          find src/test/java || echo "–ü–∞–ø–∫–∞ src/test/java –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Detect changed test classes
        id: detect
        if: ${{ github.event.inputs.run_mode == 'changed' || github.event_name == 'push' }}
        run: |
          git fetch origin master
          changed=$(git diff --name-only origin/master...HEAD | grep '^src/test/java/org/example/.*\.java$' || true)

          echo "–ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:"
          echo "$changed"

          test_classes=""
          for file in $changed; do
            classname=$(basename "$file" .java)
            test_classes+="$classname,"
          done

          test_classes="${test_classes%,}"  # —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–ø—è—Ç—É—é
          echo "test_classes=$test_classes" >> $GITHUB_OUTPUT

      - name: Run changed tests
        if: ${{ github.event.inputs.run_mode == 'changed' && steps.detect.outputs.test_classes != '' }}
        run: |
          echo "‚úÖ –ó–∞–ø—É—Å–∫ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤: ${{ steps.detect.outputs.test_classes }}"
          mvn test -Dtest="${{ steps.detect.outputs.test_classes }}" -X

      - name: Run all tests
        if: ${{ github.event.inputs.run_mode == 'all' }}
        run: |
          echo "üß™ –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤"
          mvn test -X

      - name: Run custom test
        if: ${{ github.event.inputs.run_mode == 'custom' && github.event.inputs.test_class != '' }}
        run: |
          echo "‚öôÔ∏è –ó–∞–ø—É—Å–∫ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞: ${{ github.event.inputs.test_class }}"
          mvn test -Dtest="${{ github.event.inputs.test_class }}" -X

      - name: Run tests by tag
        if: ${{ github.event.inputs.run_mode == 'tag' && github.event.inputs.tag != '' }}
        run: |
          echo "üè∑Ô∏è –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å —Ç–µ–≥–æ–º: ${{ github.event.inputs.tag }}"
          mvn test -Dgroups="${{ github.event.inputs.tag }}" -X

      - name: Show surefire reports folder content
        run: |
          echo "üìÑ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ target/surefire-reports:"
          ls -la target/surefire-reports || echo "–ü–∞–ø–∫–∞ —Å –æ—Ç—á–µ—Ç–∞–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"

      - name: Show surefire reports content
        run: |
          echo "üìë –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç—á–µ—Ç–æ–≤ surefire:"
          cat target/surefire-reports/*.txt || echo "–û—Ç—á–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
